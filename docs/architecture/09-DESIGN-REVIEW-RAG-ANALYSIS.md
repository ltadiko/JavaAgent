# 09 — Design Review & RAG Analysis

## 1. Pre-Implementation Readiness Checklist

### 1.1 What's Covered ✅

| Area                         | Status | Document(s)                          |
|------------------------------|--------|--------------------------------------|
| System architecture          | ✅     | `00-SYSTEM-ARCHITECTURE.md`          |
| Multi-tenancy & data residency | ✅   | `00-SYSTEM-ARCHITECTURE.md` §5       |
| PII encryption strategy      | ✅     | `00-SYSTEM-ARCHITECTURE.md` §6, `07-DATA-MODEL.md` §5 |
| Auth (Spring Auth Server)    | ✅     | `01-UC-REGISTER-LOGIN.md`            |
| CV upload & AI parsing       | ✅     | `02-UC-UPLOAD-CV.md`                 |
| Job search & ranking         | ✅     | `03-UC-SEARCH-JOBS.md`               |
| Motivation letter generation | ✅     | `04-UC-GENERATE-MOTIVATION.md`       |
| Automated application        | ✅     | `05-UC-APPLY-JOB.md`                 |
| Application dashboard        | ✅     | `06-UC-VIEW-APPLICATIONS.md`         |
| Complete data model + DDL    | ✅     | `07-DATA-MODEL.md`                   |
| Frontend (Vue.js SPA)        | ✅     | `08-UC-UI-MODULE.md`                 |
| AI provider strategy (Ollama/OpenAI) | ✅ | `00-SYSTEM-ARCHITECTURE.md` §8.1 |
| Docker Compose (local dev)   | ✅     | `00-SYSTEM-ARCHITECTURE.md` §8       |
| Kubernetes deployment        | ✅     | `00-SYSTEM-ARCHITECTURE.md` §9       |
| API endpoints (all use cases)| ✅     | UC-01 through UC-06                  |
| Testing strategy             | ✅     | Each UC document                     |
| **RAG with PgVectorStore**   | ✅     | UC-02, UC-03, UC-04, `07-DATA-MODEL.md` §3.3.1 |

### 1.2 Minor Gaps to Address During Sprint 0 (not blockers)

| Gap                              | Impact | Resolution                                           |
|----------------------------------|--------|------------------------------------------------------|
| No `Dockerfile` for backend yet  | Low    | Create during Sprint 0 (standard Spring Boot + JRE)  |
| No `.gitignore` configured       | Low    | Add during Sprint 0                                  |
| No OpenAPI/Swagger spec          | Low    | Auto-generated by SpringDoc at runtime               |
| No health check / readiness probes | Low  | Add Spring Boot Actuator endpoints during Sprint 0   |
| No structured logging config     | Low    | Add logback-spring.xml during Sprint 0               |
| No API versioning strategy doc   | Low    | Using URL versioning (`/api/v1/`), already in endpoints |

**Verdict: ✅ Ready to start implementation.** The minor gaps are standard boilerplate that naturally gets created during Sprint 0.

---

## 2. RAG Strategy: PgVectorStore (Spring AI)

### 2.1 Decision: **RAG is part of v1** ✅

We use **pgvector as both the vector database and RAG store** via Spring AI's `PgVectorStore`.  
No separate vector database is needed — pgvector runs inside the same PostgreSQL instance.

### 2.2 What Is RAG?

**Retrieval-Augmented Generation (RAG)** = Before calling the LLM, retrieve relevant chunks from a knowledge base (using vector similarity search), then inject those chunks into the prompt as context. This grounds the LLM's output in actual data rather than relying purely on its training knowledge.

### 2.3 How RAG Is Used in Each Use Case

| Use Case | RAG Role | How It Works |
|----------|----------|--------------|
| **UC-02: Upload CV** | **Ingestion** — CV is chunked by section and ingested into `PgVectorStore` | After AI parsing, the CV text is split into chunks (SKILLS, EXPERIENCE, EDUCATION, PROJECTS, SUMMARY). Each chunk is stored as a `Document` in the `vector_store` table with metadata (`tenant_id`, `cv_id`, `section`, `doc_type=cv_chunk`). Embeddings are auto-generated by `EmbeddingModel`. |
| **UC-03: Search Jobs** | **Retrieval** — RAG retrieves relevant CV chunks for match explanation | After ranking jobs by cosine similarity, the top-N job descriptions are used as queries against the vector store. Retrieved CV chunks power LLM-generated match explanations (`matchedSkills`, `missingSkills`, `reasoning`). |
| **UC-04: Motivation Letter** | **Full RAG pipeline** — `QuestionAnswerAdvisor` retrieves + augments + generates | The `MotivationWriterAgent` uses Spring AI's `QuestionAnswerAdvisor` which automatically: (1) embeds the job description, (2) retrieves top-5 most relevant CV chunks, (3) injects them as context, (4) LLM generates a letter grounded in the retrieved sections. |
| **UC-05: Apply to Job** | Not used | Application submission is mechanical (email/API/form); no RAG needed. |

### 2.4 Vector Store Configuration

```yaml
# application-local.yml (Ollama)
spring:
  ai:
    vectorstore:
      pgvector:
        index-type: hnsw
        distance-type: cosine_distance
        dimensions: 768              # nomic-embed-text (Ollama)
        remove-existing-vector-store-table: false
        schema-name: public
        table-name: vector_store

# application-prod.yml (OpenAI)
spring:
  ai:
    vectorstore:
      pgvector:
        dimensions: 1536             # text-embedding-3-small (OpenAI)
```

### 2.5 Why pgvector (Not a Separate Vector DB)

| Criterion            | pgvector (PgVectorStore)                            | Separate DB (Chroma/Qdrant/Milvus)           |
|----------------------|----------------------------------------------------|----------------------------------------------|
| **Extra infra**      | ❌ None — same Postgres                             | ✅ Additional container/service              |
| **Transactions**     | ✅ CV chunks + metadata in same DB transaction      | ❌ Eventually consistent                     |
| **Multi-tenancy**    | ✅ SQL `WHERE` filter on `tenant_id` in metadata    | Manual partitioning                          |
| **Spring AI support**| ✅ Native `PgVectorStore` auto-config               | ✅ Available but extra config                |
| **HNSW index**       | ✅ pgvector 0.7+                                    | ✅                                           |
| **Scale ceiling**    | ~10M vectors (sufficient for our use case)           | 100M+ (overkill for v1)                     |
| **Operational cost** | Zero additional                                      | Medium–High                                  |

### 2.6 v2 RAG Enhancements (Future)

When the application matures, the same `PgVectorStore` can be extended:

| Enhancement | `doc_type` | Source | Trigger |
|-------------|-----------|--------|---------|
| Company knowledge base | `company_knowledge` | Scraped company websites, Glassdoor reviews, news | User feedback: "letters are too generic about the company" |
| Past successful letters | `successful_letter` | Letters that led to interviews (user-marked) | Enough data to learn patterns |
| Job-specific Q&A | `job_qa` | Common application form questions + past answers | UC-05 needs smarter form filling |

No architectural changes needed — just ingest new `Document` types with different `doc_type` metadata into the same `vector_store` table.

---

## 3. Summary

| Question | Answer |
|----------|--------|
| **Ready to start implementation?** | **Yes.** All 10 architecture documents are complete. Minor gaps (Dockerfile, .gitignore, Actuator) are Sprint 0 boilerplate. |
| **Any design gaps?** | **No blockers.** See §1.2 for minor items resolved during Sprint 0. |
| **Is RAG included?** | **Yes — in v1.** PgVectorStore is the RAG knowledge base. CV chunks are ingested during UC-02. RAG retrieval powers UC-03 match explanations and UC-04 motivation letter generation. |
| **Vector database choice?** | **pgvector (PgVectorStore).** No separate vector DB needed. Same PostgreSQL, same transactions, same multi-tenancy. |
| **Is it extensible?** | **Yes.** Adding company knowledge or past letter patterns = ingesting new `doc_type` documents into the same store. |
